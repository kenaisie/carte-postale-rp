<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Carte Postale RP</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Playfair+Display:wght@400;700&family=Cormorant+Garamond&family=Homemade+Apple&display=swap" rel="stylesheet">

  <style>
    :root{--bg:#f3efe6;}
    *{box-sizing:border-box;}
    body{
      font-family:"Playfair Display",serif;
      background:var(--bg);
      margin:0;
      color:#222;
      padding:18px;
    }
    header{display:flex;gap:16px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:20px}
    .wrap{max-width:1200px;margin:18px auto}
    .controls{display:grid;grid-template-columns:320px 1fr;gap:18px;margin-top:18px}
    .panel{
      background:#fff;
      padding:14px;
      border-radius:10px;
      box-shadow:0 6px 18px rgba(0,0,0,.06)
    }
    label{display:block;font-size:13px;margin-top:8px}
    input[type=text], select, textarea{
      width:100%;
      padding:8px;
      border-radius:6px;
      border:1px solid #ddd;
      font-size:14px
    }
    button{
      padding:10px 12px;
      border-radius:8px;
      border:0;
      background:#2f5d3b;
      color:#fff;
      font-weight:600;
      cursor:pointer
    }
    small{color:#666}

    .postcard{
      width:640px;
      height:400px;
      perspective:1200px;
      position:relative;
      margin:auto;
    }
    .inner{
      width:100%;
      height:100%;
      transform-style:preserve-3d;
      transition:transform .8s;
      position:relative;
    }
    .postcard.flipped .inner{transform:rotateY(180deg);}
    .face{
      position:absolute;
      width:100%;
      height:100%;
      backface-visibility:hidden;
      border-radius:6px;
      box-shadow:0 4px 10px rgba(0,0,0,.3);
      overflow:hidden;
    }
    .front{
      background:url("https://upload.wikimedia.org/wikipedia/commons/6/63/Postcard_front_sample.jpg") center/cover no-repeat;
    }
    .back{
      transform:rotateY(180deg);
      background:#f3efe6;
      position:relative;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      padding:30px;
    }
    textarea{
      flex:1;
      resize:none;
      border:none;
      background:transparent;
      font-family:"Homemade Apple",cursive;
      font-size:20px;
      line-height:1.5;
      z-index:2;
      position:relative;
    }
    textarea:focus{outline:none;}
    .drawCanvas{
      position:absolute;
      inset:0;
      z-index:2;
      cursor:crosshair;
    }
    .previewWrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:16px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Zealandia Post Offices</h1>
      <div><small>What could be nicer than sending a pretty postcard of your adventures to a loved one?</small></div>
    </header>

    <div class="controls">
      <div class="panel">
        <h3>Creation options</h3>

        <label>Front image</label>
        <input type="file" id="uploadFront" accept="image/*">

        <label>Writing mode</label>
        <select id="mode">
          <option value="typed">Text</option>
          <option value="handwrite">Manual</option>
        </select>

        <label>Message text</label>
        <textarea id="textArea" rows="4" placeholder="My dear friend,&#10;I'm writing to you from the station..."></textarea>

        <div style="margin-top:10px;display:flex;gap:8px;">
          <button id="flipBtn">Flip</button>
          <button id="sendBtn">Send</button>
          <button id="undoBtn">Undo</button>
        </div>
      </div>

      <div class="panel previewWrap">
        <div class="postcard" id="postcard">
          <div class="inner">
            <div class="face front" id="frontFace"></div>
            <div class="face back" id="backFace">
              <canvas class="drawCanvas" id="drawCanvas"></canvas>
              <textarea id="textAreaDisplay" placeholder="Ã‰cris ton message ici..."></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const card = document.getElementById('postcard');
const front = document.getElementById('frontFace');
const back = document.getElementById('backFace');
const canvas = document.getElementById('drawCanvas');
const ctx = canvas.getContext('2d');
const textareaDisplay = document.getElementById('textAreaDisplay');
const textareaInput = document.getElementById('textArea');
const undoBtn = document.getElementById('undoBtn');

let drawing = false, lastX = 0, lastY = 0;
let mode = 'typed';
let strokes = [];
let currentStroke = [];

// --- canvas setup ---
function resizeCanvas() {
  canvas.width = back.clientWidth;
  canvas.height = back.clientHeight;
  redrawStrokes();
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

ctx.strokeStyle = '#1e1b16';
ctx.lineWidth = 2;
ctx.lineCap = 'round';

// --- drawing ---
canvas.addEventListener('mousedown', e => {
  if (mode !== 'handwrite') return;
  drawing = true;
  [lastX, lastY] = [e.offsetX, e.offsetY];
  currentStroke = [[lastX, lastY]];
});

canvas.addEventListener('mousemove', e => {
  if (!drawing || mode !== 'handwrite') return;
  ctx.beginPath();
  ctx.moveTo(lastX, lastY);
  ctx.lineTo(e.offsetX, e.offsetY);
  ctx.stroke();
  [lastX, lastY] = [e.offsetX, e.offsetY];
  currentStroke.push([lastX, lastY]);
});

['mouseup', 'mouseleave'].forEach(ev => canvas.addEventListener(ev, () => {
  if (drawing && currentStroke.length > 0) strokes.push([...currentStroke]);
  drawing = false;
}));

// --- undo ---
function undoLastStroke() {
  if (strokes.length === 0) return;
  strokes.pop();
  redrawStrokes();
}
undoBtn.addEventListener('click', undoLastStroke);

function redrawStrokes() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = '#1e1b16';
  ctx.lineWidth = 2;
  ctx.lineCap = 'round';
  for (let stroke of strokes) {
    ctx.beginPath();
    ctx.moveTo(stroke[0][0], stroke[0][1]);
    for (let i = 1; i < stroke.length; i++) {
      ctx.lineTo(stroke[i][0], stroke[i][1]);
    }
    ctx.stroke();
  }
}

// --- controls ---
document.getElementById('flipBtn').onclick = () => card.classList.toggle('flipped');

document.getElementById('mode').onchange = e => {
  mode = e.target.value;
  textareaDisplay.style.display = mode === 'typed' ? 'block' : 'none';
  canvas.style.pointerEvents = mode === 'handwrite' ? 'auto' : 'none';
};

// --- sync typed text ---
textareaInput.addEventListener('input', () => {
  textareaDisplay.value = textareaInput.value;
});

// --- upload front image ---
document.getElementById('uploadFront').addEventListener('change', ev => {
  const f = ev.target.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = e => {
    front.style.background = `url('${e.target.result}') center/cover no-repeat`;
    front.dataset.image = e.target.result;
  };
  reader.readAsDataURL(f);
});

// --- send postcard (open in viewer) ---
document.getElementById('sendBtn').onclick = () => {
  const postcardData = {
    mode,
    text: textareaInput.value,
    strokes,
    frontImage: front.dataset.image || "https://upload.wikimedia.org/wikipedia/commons/6/63/Postcard_front_sample.jpg"
  };
  const blob = new Blob([JSON.stringify(postcardData)], { type: "application/json" });
  const blobUrl = URL.createObjectURL(blob);
  window.open(`viewer.html?src=${encodeURIComponent(blobUrl)}`, "_blank");
};
</script>
</body>
</html>

